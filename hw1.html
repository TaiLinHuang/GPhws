<!DOCTYPE html>
<html>
<head>
<style>
#info {
  position: absolute;
  top: 0px;
  width: 100%;
  padding: 10px;
  text-align: center;
  color: #ffff00
}
body {
  overflow: hidden;
}
</style>
</head>
<body>
<script src="https://threejs.org/build/three.min.js"></script>
<script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<div id="info">
  <p>Game Physics</p>
</div>
<audio id="collisionsound" style="display:none">
<source src="./collision3.wav" type='audio/wav'>
</audio>
<script>
class Wall {
	constructor(x=0,y=0,z=0,px=0,py=0,pz=0) {
		this.wall = new THREE.Mesh(new THREE.BoxGeometry(x,y,z), new THREE.MeshPhongMaterial({
			color:0xD3D3D3, 
			transparent: true,
			opacity:0.4
		}));
		this.wall.position.set(px,py,pz);	
		scene.add(this.wall);	
	}
}
class Puck {
	constructor (r,h,c,sound) {
		this.puck = new THREE.Mesh(new THREE.CylinderGeometry(r, r, h,32), new THREE.MeshPhongMaterial({color: c}));
		this.puck.position.set(Math.floor(Math.random()*15), 1+h/2, Math.floor(Math.random()*15));
		this.light = new THREE.PointLight(c,2,15);
		this.light.position.set(this.puck.position.x, 1+h, this.puck.position.z);
		this.sound = sound;
		this.pos = this.puck.position;
		this.vel = new THREE.Vector3(Math.floor(Math.random()*10), 0, Math.floor(Math.random()*-10));
		scene.add(this.puck, this.light);
   }
	update(dt) {
  	this.pos.add (this.vel.clone().multiplyScalar (dt));
	if (this.pos.z < -14){	
		this.sound.load();
		this.vel.z = - this.vel.z;
		this.pos.z = -14;
		this.sound.play();
	}
	if (this.pos.z > 14){	
		this.sound.load();
		this.vel.z = - this.vel.z;
		this.pos.z = 14;
		this.sound.play();
	}
	if (this.pos.x > 24){
		this.sound.load();
		this.vel.x = - this.vel.x;
		this.pos.x = 24;
		this.sound.play();
	}
	if (this.pos.x < -24){
		this.sound.load();
		this.vel.x = - this.vel.x;
		this.pos.x = -24;
		this.sound.play();
	}	
	this.light.position.set(this.puck.position.x,1,this.puck.position.z);
}
	collision(pucks) {
		for (var i = 0; i < pucks.length; i++) {
			if (this.puck.position.distanceTo(pucks[i].puck.position) == 0);
			else if (this.puck.position.distanceTo(pucks[i].puck.position) <=2) {
			this.sound.load();
			var t_vel = this.vel.clone();
			var t = pucks[i].puck.position.clone().sub(this.puck.position).normalize();
			var d = 2 - pucks[i].puck.position.distanceTo(this.puck.position);			
			//	position reset
			this.puck.position.sub(t.multiplyScalar(d/2));
			pucks[i].puck.position.add(t.multiplyScalar(d/2));
			//	puck-puck collision
			this.vel = t_vel.sub(this.puck.position.clone().sub(pucks[i].puck.position).multiplyScalar(t_vel.sub(pucks[i].vel).dot(this.puck.position.clone().sub(pucks[i].puck.position)) / this.puck.position.clone().distanceToSquared(pucks[i].puck.position)));
			pucks[i].vel = pucks[i].vel.clone().sub(pucks[i].puck.position.clone().sub(this.puck.position).multiplyScalar(pucks[i].vel.clone().sub(t_vel).dot(pucks[i].puck.position.clone().sub(this.puck.position)) / pucks[i].puck.position.clone().distanceToSquared(this.puck.position)));
			this.sound.play();
			}
			else {
				this.puck.position.copy (this.puck.position);
				pucks[i].puck.position.copy (pucks[i].puck.position);
			}
		} 
	}
}
var camera, scene, renderer;
var collisionSound;
var pucks = [];
init();
animate();
function init() {
  collisionSound = document.getElementById ('collisionsound');
  scene = new THREE.Scene();
  renderer = new THREE.WebGLRenderer();
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setClearColor(0x696969);
  document.body.appendChild(renderer.domElement);
  camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 1000);
  camera.position.set(0, 30, 40);
  let controls = new THREE.OrbitControls(camera, renderer.domElement);
  ////////////////////////////////////////////////////////////////
  var gridXZ = new THREE.GridHelper(200, 20, 'red', 'white');
  //scene.add(gridXZ);
  const light1 = new THREE.PointLight(0xffffff);
  light1.position.set(0, 1000, 0);
  const light2 = new THREE.AmbientLight(0x000000); 
  light2.position.set(0, 50, 0);
  const ground = new THREE.Mesh(new THREE.BoxGeometry(50, 2, 30), new THREE.MeshPhongMaterial({
    color: 0x808080
  }));
  scene.add(light1,light2,ground);
  var wall1 = new Wall(2,8,34,26,3,0);
  var wall2 = new Wall(2,8,34,-26,3,0);
  var wall3 = new Wall(50,8,2,0,3,16);
  var wall4 = new Wall(50,8,2,0,3,-16);
  puck1 = new Puck(1, 0.5, new THREE.Color(0xFF0000), collisionSound);
  puck2 = new Puck(1, 0.5, new THREE.Color(0xFFFF00), collisionSound);
  puck3 = new Puck(1, 0.5, new THREE.Color(0x00FF00), collisionSound);
  puck4 = new Puck(1, 0.5, new THREE.Color(0x00FFFF), collisionSound);
  puck5 = new Puck(1, 0.5, new THREE.Color(0xFF00FF), collisionSound);
  pucks.push(puck1, puck2, puck3, puck4, puck5);
}

function onWindowResize() {
  var width = window.innerWidth;
  var height = window.innerHeight;
  camera.aspect = width / height;
  camera.updateProjectionMatrix();
  renderer.setSize(width, height);
}

function animate() {
var dt = 0.01;
	pucks.forEach(function(p){
		p.update(dt);
		p.collision(pucks);
	})
  requestAnimationFrame(animate);
  render();
}

function render() {
  renderer.render(scene, camera);
}
</script>
</body>
</html>